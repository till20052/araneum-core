<?php

namespace Araneum\Bundle\MainBundle\Repository;

use Araneum\Bundle\AgentBundle\Entity\ApplicationLog;
use Araneum\Bundle\MainBundle\Entity\Application;
use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\DBAL\Types\Type;
use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query\Parameter;

/**
 * ApplicationRepository
 *
 * This class was generated by the PhpStorm "Php Annotations" Plugin. Add your own custom
 * repository methods below.
 */
class ApplicationRepository extends EntityRepository
{
    /**
     * Get statistics of all applications by next conditions:
     *  - online
     *  - has problems
     *  - has errors
     *  - disabled
     *
     * return \stdClass
     */
    public function getApplicationsStatistics()
    {
        return (object)$this->createQueryBuilder('A')
            ->select('SUM(CASE WHEN A.enabled = TRUE AND A.status = :online THEN 1 ELSE 0 END) AS online')
            ->addSelect('SUM(CASE WHEN A.enabled = TRUE AND A.status = :hasProblem THEN 1 ELSE 0 END) as hasProblems')
            ->addSelect('SUM(CASE WHEN A.status > :hasProblem THEN 1 ELSE 0 END) as hasErrors')
            ->addSelect('SUM(CASE WHEN A.enabled = FALSE THEN 1 ELSE 0 END) as disabled')
            ->setParameters(
                [
                    'online' => Application::STATUS_OK,
                    'hasProblem' => Application::STATUS_CODE_INCORRECT
                ]
            )
            ->getQuery()
            ->getOneOrNullResult();
    }

    /**
     * Get statistic of all application by last 24 hours
     *
     * @return array
     */
    public function getApplicationStatusesDayly()
    {
        $qb = $this->createQueryBuilder('a');

        $qb
            ->select('a.name')
            ->addSelect('SUM(CAST(CASE WHEN l.status = :errors THEN 1 ELSE 0 END AS FLOAT)) / COUNT(a.id) * 100 AS errors')
            ->addSelect('SUM(CAST(CASE WHEN l.status = :problems  THEN 1 ELSE 0 END AS FLOAT)) / COUNT(a.id) * 100 AS problems')
            ->addSelect('SUM(CAST(CASE WHEN l.status = :success  THEN 1 ELSE 0 END AS FLOAT)) / COUNT(a.id) * 100 AS success')
            ->addSelect('SUM(CAST(CASE WHEN l.status = :disabled THEN 1 ELSE 0 END AS FLOAT)) / COUNT(a.id) * 100 AS disabled')
            ->leftJoin('AraneumAgentBundle:ApplicationLog', 'l', 'WITH', $qb->expr()->andX(
                $qb->expr()->eq('l.application', 'a'),
                $qb->expr()->between('l.createdAt', ':start', ':end')
            ))
            ->groupBy('a.name')
            ->setParameters(
                [
                    'errors' => Application::STATUS_ERROR,
                    'problems'=> Application::STATUS_CODE_INCORRECT,
                    'success' => Application::STATUS_OK,
                    'disabled' => Application::STATUS_DISABLED,
                    'start' => date('Y-m-d H:i:s', time() - 86400),
                    'end'=> date('Y-m-d H:i:s', time())
                ]);

        $result = $qb->getQuery()->getResult();
        return $result;
    }
}