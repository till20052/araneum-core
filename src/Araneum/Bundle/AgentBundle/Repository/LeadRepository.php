<?php

namespace Araneum\Bundle\AgentBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * LeadRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class LeadRepository extends EntityRepository
{
	/**
	 * Find leads by filter.
	 * Filter contain next keys: email, phone.
	 *
	 * @param array $filter
	 * @return array
	 */
	public function findByFilter($filter = [])
	{
		$queryBuilder = $this->createQueryBuilder('l');

		if (isset($filter['email']) && preg_match('/[\w\d\.\-\@]{3,}/', $filter['email'])) {
			$queryBuilder->where('l.email LIKE :email')
				->setParameter('email', $filter['email'].'%');
		}

		if (isset($filter['phone']) && preg_match('/[0-9\-\(\)]{3,17}/', $filter['phone'])) {
			$queryBuilder->andWhere('l.phone LIKE :phone')
				->setParameter('phone', $filter['phone'].'%');
		}

		return $queryBuilder->getQuery()->getResult();
	}
}
